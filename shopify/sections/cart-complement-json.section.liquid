{% liquid
  if cart.item_count == 0
    assign carItems = '[]'
  else
    assign product_discounts = 0
    assign carItems = '['
    for line_item in cart.items
      if forloop.index != 1
        assign carItems = carItems | append: ','
      endif
      assign variant = line_item.variant | json
      assign variant_inventory_policy = line_item.variant.inventory_policy | json
      assign variant_inventory_quantity = line_item.variant.inventory_quantity | json

      assign collections = line_item.product.collections | map: 'title' | join: ','

      assign line = '{ "id":' | append: line_item.id | append: ','
      assign line = line | append: '"handle": "' | append: line_item.product.handle | append: '",'
      assign line = line | append: '"barcode": "' | append: line_item.variant.barcode | append: '",'
      assign collections_cleaned = collections | replace: '"', '\"'
      assign line = line | append: '"collection_names": "' | append: collections_cleaned | append: '",'
      assign line = line | append: '"variant":' | append: variant | append: ','
      assign line = line | append: '"variant_complement": {'
      assign line = line | append: '"inventory_quantity": ' | append: variant_inventory_quantity | append: ','
      assign line = line | append: '"inventory_policy": ' | append: variant_inventory_policy
      assign line = line | append: '},'
      assign line = line | append: '"url_to_remove":"' | append: line_item.url_to_remove | append: '"'
      assign line = line | append: '}'
      assign carItems = carItems | append: line

      assign compare_at_price = line_item.variant.compare_at_price | minus: 0
      if compare_at_price != 0
        assign unitPriceDelta = compare_at_price | minus: line_item.variant.price
        if unitPriceDelta != 0
          assign priceDelta = unitPriceDelta | times: line_item.quantity
          assign product_discounts = product_discounts | plus: priceDelta
        endif
      endif
    endfor
    assign carItems = carItems | append: ']'
  endif

  assign original_total_price = cart.original_total_price | plus: product_discounts
%}

{% capture json %}
{
  "items" : {{ carItems }},
  "original_total_price" : {{ original_total_price }}
}

{% endcapture %}
{{ json }}
