{% capture section_style %}
  --prev-next-button-background: {{ settings.background.red }}, {{ settings.background.green }}, {{ settings.background.blue }};
  --prev-next-button-color: {{ settings.text_color.red }}, {{ settings.text_color.green }}, {{ settings.text_color.blue }};
{% endcapture %}

{% capture extra_style %}
  #shopify-section-{{ section.id }} .slideshow__arrow--next,
  #shopify-section-{{ section.id }} .slideshow__arrow--prev {
  display: none;
  }

  @media screen and (min-width: 1000px) {
  #shopify-section-{{ section.id }} .slideshow__arrow--next {
  right: -35px;
  display: block;
  }

  #shopify-section-{{ section.id }} .slideshow__arrow--prev {
  left: -35px;
  display: block;
  }

  }

  {%- if section.settings.title == blank and section.settings.subheading == blank and section.settings.content == blank -%}
    #shopify-section-{{ section.id }} {
    --vertical-breather: 40px; /* Only on multi-column section, due to its specific usage we reduce spacing when no content */
    }

    {%- if blends_with_background or section.settings.mobile_item_size == 'small' -%}
      /* Reduce the margin on small devices to create a slightly better layout */
      @media screen and (max-width: 999px) {
      #shopify-section-{{ section.id }} {
      --vertical-breather: var(--container-gutter);
      }
      }
    {%- endif -%}
  {%- endif -%}

  {%- for block in section.blocks -%}
    {%- if block.settings.image_border != 'rgba(0,0,0,0)' -%}
      #block-{{ section.id }}-{{ block.id }} .multi-column__image-wrapper {
      border: 1px solid {{ block.settings.image_border }};
      }
    {%- endif -%}
  {%- endfor -%}
{% endcapture %}

{% capture content %}
  {%- if section.blocks.size > 0 -%}
    <multi-column
      {% if section.settings.stack_items %}
        stack
      {% endif %}
      {% if section.settings.reveal_on_scroll %}
        stagger-apparition
      {% endif %}
      class="multi-column multi-column--pocket-{{ section.settings.mobile_item_size }} multi-column--{{ section.settings.desktop_item_size }} multi-column--spacing-{{ section.settings.spacing }}"
    >
      {%- assign align_arrows_on_image = true -%}
      {%- assign smallest_image_aspect_ratio = 0 -%}

      <div
        {% unless section.settings.stack_items %}
          class="scroller"
        {% endunless %}
      >
        <scrollable-content class="multi-column__inner multi-column__inner--{{ section.settings.column_alignment }} {% unless section.settings.stack_items %}multi-column__inner--scroller{% endunless %}">
          {%- case section.settings.desktop_item_size -%}
            {%- when 'pico' -%}
              {%- assign desktop_items_per_row = 8 -%}
            {%- when 'small' -%}
              {%- assign desktop_items_per_row = 7 -%}
            {%- when 'medium' -%}
              {%- assign desktop_items_per_row = 5 -%}
            {%- when 'large' -%}
              {%- assign desktop_items_per_row = 3 -%}
          {%- endcase -%}

          {%- if section.settings.stack_items -%}
            {%- case section.settings.mobile_item_size -%}
              {%- when 'small' -%}
                {%- assign mobile_calculated_size = 'calc(50vw - 48px)' -%}
                {%- assign tablet_calculated_size = 'calc(20vw - 80px)' -%}
              {%- when 'medium' -%}
                {%- assign mobile_calculated_size = 'calc(100vw - 48px)' -%}
                {%- assign tablet_calculated_size = 'calc(25vw - 80px)' -%}
              {%- when 'large' -%}
                {%- assign mobile_calculated_size = 'calc(100vw - 48px)' -%}
                {%- assign tablet_calculated_size = 'calc(33vw - 80px)' -%}
            {%- endcase -%}
          {%- else -%}
            {%- case section.settings.mobile_item_size -%}
              {%- when 'small' -%}
                {%- assign mobile_calculated_size = '25vw' -%}
                {%- assign tablet_calculated_size = '20vw' -%}
              {%- when 'medium' -%}
                {%- assign mobile_calculated_size = '35vw' -%}
                {%- assign tablet_calculated_size = '26vw' -%}
              {%- when 'large' -%}
                {%- assign mobile_calculated_size = '56vw' -%}
                {%- assign tablet_calculated_size = '36vw' -%}
            {%- endcase -%}
          {%- endif -%}

          {%- case section.settings.spacing -%}
            {%- when 'tight' -%}
              {%- assign desktop_item_gap = 24 -%}
            {%- when 'normal' -%}
              {%- assign desktop_item_gap = 40 -%}
            {%- when 'loose' -%}
              {%- assign desktop_item_gap = 60 -%}
          {%- endcase -%}

          {%- assign desktop_items_per_row_minus_one = desktop_items_per_row | minus: 1 -%}
          {%- assign gap_width = desktop_item_gap
            | divided_by: desktop_items_per_row
            | times: desktop_items_per_row_minus_one
          -%}

          {%- for block in section.blocks -%}
            {%- capture block_content -%}
              {%- if block.settings.image != blank -%}
                {%- assign smallest_image_aspect_ratio = smallest_image_aspect_ratio | at_least: block.settings.image.aspect_ratio -%}
                {%- capture sizes_attribute -%}(max-width: 740px) {{ mobile_calculated_size }}, (max-width: 999px) {{ tablet_calculated_size }}, {{ 1520.0 | divided_by: desktop_items_per_row | minus: gap_width | ceil }}px{%- endcapture -%}

                {%- if block.settings.link_url != blank -%}
                  <a href="{{ block.settings.link_url }}" class="multi-column__image-wrapper" style="max-width: {{ block.settings.image_width }}%; width: {{ block.settings.image.width }}px">
                    {{- block.settings.image | image_url: width: block.settings.image.width | image_tag: loading: 'lazy', sizes: sizes_attribute, widths: '200,300,400,500,600,700,800,900,1000,1100,1200', class: 'multi-column__image' -}}
                  </a>
                {%- else -%}
                  <div class="multi-column__image-wrapper" style="max-width: {{ block.settings.image_width }}%; width: {{ block.settings.image.width }}px">
                    {{- block.settings.image | image_url: width: block.settings.image.width | image_tag: loading: 'lazy', sizes: sizes_attribute, widths: '200,300,400,500,600,700,800,900,1000,1100,1200', class: 'multi-column__image' -}}
                  </div>
                {%- endif -%}
              {%- else -%}
                {%- assign align_arrows_on_image = false -%}
              {%- endif -%}

              {%- if block.settings.title != blank or block.settings.content != blank or block.settings.link_text != blank -%}
                <div class="multi-column__text-container text--{{ block.settings.text_alignment }} text-container">
                  {%- if block.settings.title != blank -%}
                    <p class="heading h5">{{ block.settings.title | escape }}</p>
                  {%- endif -%}

                  {%- if block.settings.content != blank -%}
                    {{- block.settings.content -}}
                  {%- endif -%}

                  {%- if block.settings.link_text != blank -%}
                    {%- if block.settings.link_style == 'link' -%}
                      <a href="{{ block.settings.link_url }}" class="multi-column__link heading heading--small link">{{ block.settings.link_text | escape }}</a>
                    {%- else -%}
                      <div class="button-wrapper">
                        <a href="{{ block.settings.link_url }}" class="multi-column__button button button--small button--primary">{{ block.settings.link_text | escape }}</a>
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endif -%}
            {%- endcapture -%}

            {%- if block_content != blank -%}
              <div
                id="block-{{ section.id }}-{{ block.id }}"
                class="multi-column__item multi-column__item--align-{{ block.settings.vertical_alignment }} {% if block.settings.link_url != blank %}image-zoom{% endif %}"
                {% if section.settings.reveal_on_scroll %}
                  reveal
                {% endif %}
                {{ block.shopify_attributes }}
              >
                {{- block_content -}}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </scrollable-content>

        {%- unless section.settings.stack_items -%}
          {%- if section.settings.always_show -%}
            <prev-next-buttons class="slideshow__prev-next-buttons hidden-phone">
              <button class="slideshow__arrow slideshow__arrow--prev">
                <span class="visually-hidden">{{ 'general.accessibility.previous' | t }}</span>
                {%- include 'icon' with 'nav-arrow-left', direction_aware: true -%}
              </button>

              <button class="slideshow__arrow slideshow__arrow--next">
                <span class="visually-hidden">{{ 'general.accessibility.next' | t }}</span>
                {%- include 'icon' with 'nav-arrow-right', direction_aware: true -%}
              </button>
            </prev-next-buttons>
          {%- else -%}
            <prev-next-buttons
              class="multi-column__prev-next {% unless align_arrows_on_image %}multi-column__prev-next--no-image{% endunless %} hidden-pocket"
              {% if align_arrows_on_image %}
                style="--smallest-image-aspect-ratio: {{ smallest_image_aspect_ratio }}"
              {% endif %}
            >
              <button class="multi-column__arrow prev-next-button prev-next-button--prev" disabled>
                <span class="visually-hidden">{{ 'general.accessibility.previous' | t }}</span>
                {%- include 'icon' with 'nav-arrow-left', block: true, direction_aware: true -%}
              </button>

              <button class="multi-column__arrow prev-next-button prev-next-button--next">
                <span class="visually-hidden">{{ 'general.accessibility.next' | t }}</span>
                {%- include 'icon' with 'nav-arrow-right', block: true, direction_aware: true -%}
              </button>
            </prev-next-buttons>
          {%- endif -%}
        {%- endunless -%}
      </div>
    </multi-column>
  {%- endif -%}
{% endcapture %}

{% render 'section-layout',
  content: content,
  extra_section_style: section_style,
  extra_style: extra_style,
  module: 'multi-column'
%}
