{%- comment -%}
  ------------------------------------------------------------------------------------
   USED IN AJAX
   with usign search API
  ------------------------------------------------------------------------------------
{%- endcomment -%}

{%- liquid
  assign page_url = content_for_header | split: '"pageurl":"' | last | split: '"' | first
  assign page_url = page_url | replace: '\/', '/' | replace: '%20', ' ' | replace: '%7C', '|' | replace: '%2C', ','
  assign page_url = page_url | split: '?' | last
  assign page_url = page_url | split: '\u0026'

  assign desktop_products_per_row = 4
  assign mobile_products_per_row = 2
  assign page_size = 50
  # can be 'infinite' or 'infinite_scroll'
  assign pagination_type = 'infinite_scroll'

  for param in page_url
    assign pair = param | split: '='
    if pair[0] == 'list_id'
      assign list_id = pair[1]
    endif
    if pair[0] == 'desktop_products_per_row'
      assign desktop_products_per_row = pair[1]
    endif
    if pair[0] == 'mobile_products_per_row'
      assign mobile_products_per_row = pair[1]
    endif
    if pair[0] == 'page_size'
      assign page_size = pair[1]
    endif
    if pair[0] == 'pagination_type'
      assign pagination_type = pair[1]
    endif
  endfor
%}
{% paginate search.results by page_size %}
  <product-list
    {% if settings.stagger_products_apparition %}
      stagger-apparition
    {% endif %}
    class="product-list anchor"
    items-count="{{ paginate.items }}"
  >
    <div class="product-list__inner">
      {%- assign desktop_number_of_products_minus_one = desktop_products_per_row | minus: 1 -%}
      {%- assign gap_width = 24.0
        | divided_by: desktop_products_per_row
        | times: desktop_number_of_products_minus_one
      -%}

      {%- capture sizes_attribute -%}(max-width: 740px) calc({{ 100.0 | divided_by: mobile_products_per_row | ceil }}vw - 24px), calc((min(100vw - 80px, 1520px)/ {{ desktop_products_per_row }} - {{ gap_width | ceil }}px){%- endcapture -%}

      {% for product in search.results %}
        {% if product.type != 'static' %}
          {%- render 'product-item',
            product: product,
            sizes_attribute: sizes_attribute,
            reveal: settings.stagger_products_apparition,
            list: list_id,
            position: forloop.index,
            class: 'product-list__item',
            enable_media_in_slider: settings.enable_media_in_slider_sections
          -%}
        {% endif %}
      {%- endfor -%}
    </div>
    {%- render 'pagination',
      paginate: paginate,
      use_ajax: true,
      infinite: true,
      infinite_type: pagination_type,
      next_page_text: 'collection.general.pagination.next_page',
      progress_text: 'collection.general.pagination.progress'
    -%}
  </product-list>
{% endpaginate %}
