{%- liquid
  assign page_url = content_for_header | split: '"pageurl":"' | last | split: '"' | first
  assign page_url = page_url | replace: '\/', '/' | replace: '%20', ' '
  assign page_url = page_url | split: '?'
  assign page_url = page_url[1]
  assign page_url = page_url | split: '\u0026'

  assign is_ajax = false

  for param in page_url
    assign pair = param | split: '='
    if pair[0] == 'sections%5B%5D'
      assign is_ajax = true
    endif
    if pair[0] == 'sections'
      assign is_ajax = true
    endif
  endfor
%}
{%- assign featured_product = section.settings.product -%}

{% if is_ajax == true %}
  {%- assign featured_product = product -%}
{% endif %}

{% capture section_style %}
  {%- assign buy_buttons_block = section.blocks | where: 'type', 'buy_buttons' | first -%}

  {%- if buy_buttons_block.settings.show_payment_button -%}
    {%- if buy_buttons_block.settings.atc_button_background == 'rgba(0,0,0,0)' -%}
      {%- assign secondary_button_background = settings.secondary_button_background -%}
    {%- else -%}
      {%- assign secondary_button_background = buy_buttons_block.settings.atc_button_background -%}
    {%- endif -%}

    {%- if buy_buttons_block.settings.atc_button_text_color == 'rgba(0,0,0,0)' -%}
      {%- assign secondary_button_text_color = settings.secondary_button_text_color -%}
    {%- else -%}
      {%- assign secondary_button_text_color = buy_buttons_block.settings.atc_button_text_color -%}
    {%- endif -%}

    {%- if buy_buttons_block.settings.buy_now_button_background == 'rgba(0,0,0,0)' -%}
      {%- assign primary_button_background = settings.primary_button_background -%}
    {%- else -%}
      {%- assign primary_button_background = buy_buttons_block.settings.buy_now_button_background -%}
    {%- endif -%}

    {%- if buy_buttons_block.settings.buy_now_button_text_color == 'rgba(0,0,0,0)' -%}
      {%- assign primary_button_text_color = settings.primary_button_text_color -%}
    {%- else -%}
      {%- assign primary_button_text_color = buy_buttons_block.settings.buy_now_button_text_color -%}
    {%- endif -%}
  {%- else -%}
    {%- if buy_buttons_block.settings.atc_button_background == 'rgba(0,0,0,0)' -%}
      {%- assign primary_button_background = settings.primary_button_background -%}
    {%- else -%}
      {%- assign primary_button_background = buy_buttons_block.settings.atc_button_background -%}
    {%- endif -%}

    {%- if buy_buttons_block.settings.atc_button_text_color == 'rgba(0,0,0,0)' -%}
      {%- assign primary_button_text_color = settings.primary_button_text_color -%}
    {%- else -%}
      {%- assign primary_button_text_color = buy_buttons_block.settings.atc_button_text_color -%}
    {%- endif -%}
  {%- endif -%}

  --primary-button-background: {{ primary_button_background.red }}, {{ primary_button_background.green }}, {{ primary_button_background.blue }};
  --primary-button-text-color: {{ primary_button_text_color.red }}, {{ primary_button_text_color.green }}, {{ primary_button_text_color.blue }};
  --secondary-button-background: {{ secondary_button_background.red }}, {{ secondary_button_background.green }}, {{ secondary_button_background.blue }};
  --secondary-button-text-color: {{ secondary_button_text_color.red }}, {{ secondary_button_text_color.green }}, {{ secondary_button_text_color.blue }};

  {%- if section_background != settings.background -%}
    --product-in-stock-text-color: {{ text_color.red }}, {{ text_color.green }}, {{ text_color.blue }};
    --product-low-stock-text-color: {{ text_color.red }}, {{ text_color.green }}, {{ text_color.blue }};
  {%- endif -%}

  {%- if section.settings.background == 'rgba(0,0,0,0)' -%}
    {%- assign section_background = settings.background -%}
    {%- assign section_secondary_background = settings.secondary_background -%}
  {%- else -%}
    {%- assign section_background = section.settings.background -%}
    {%- assign section_secondary_background = section.settings.background | color_mix: text_color, 85 -%}
  {%- endif -%}

  --section-background: {{ section_background.red }}, {{ section_background.green }}, {{ section_background.blue }};
  --background: {{ section_background.red }}, {{ section_background.green }}, {{ section_background.blue }};
  --secondary-background: {{ section_secondary_background.red }}, {{ section_secondary_background.green }}, {{ section_secondary_background.blue }};
{% endcapture %}

{% assign product_handle = featured_product.handle | default: 'null' %}
{% assign section_attributes = 'data-product-handle||'
  | append: product_handle
  | append: '[]'
  | append: 'data-product-id||'
  | append: product.id
%}

{% capture content %}
  <div class="product product--featured product--thumbnails-{{ section.settings.desktop_thumbnails_position }}">
    {%- if featured_product != blank -%}
      {%- render 'product-media', product: featured_product -%}
      {%- render 'product-info',
        product: featured_product,
        featured: true,
        update_url: false,
        location: 'featured'
      -%}
    {%- else -%}
      {%- comment -%}
        ----------------------------------------------------------------------------------------------------------------
        NOTE: all the code below is just rendering placeholder data for the theme editor.
        ----------------------------------------------------------------------------------------------------------------
      {%- endcomment -%}
      <product-media class="product__media" style="--largest-image-aspect-ratio: 1">
        <div class="product__media-list-wrapper">
          {%- capture flickity_config -%}
            {
            "adaptiveHeight": true,
            "dragThreshold": 10,
            "fade": {% if section.settings.transition_effect == 'fade' %}true{% else %}false{% endif %},
            "draggable": ">1",
            "contain": true,
            "percentPosition": false,
            "pageDots": false,
            "prevNextButtons": false
            }
          {%- endcapture -%}

          <flickity-carousel
            flickity-config="{{ flickity_config | escape }}"
            id="product-{{ section.id }}-placeholder-media-list"
            class="product__media-list"
          >
            <div
              id="product-{{ section.id }}-media-1"
              class="product__media-item is-selected"
              data-media-type="image"
              data-media-id="media-1"
            >
              {{- 'product-1' | placeholder_svg_tag: 'placeholder-background' -}}
            </div>
            <div
              id="product-{{ section.id }}-media-2"
              class="product__media-item"
              data-media-type="image"
              data-media-id="media-2"
            >
              {{- 'product-2' | placeholder_svg_tag: 'placeholder-background' -}}
            </div>
            <div
              id="product-{{ section.id }}-media-3"
              class="product__media-item"
              data-media-type="image"
              data-media-id="media-3"
            >
              {{- 'product-3' | placeholder_svg_tag: 'placeholder-background' -}}
            </div>
          </flickity-carousel>
        </div>

        <flickity-controls controls="product-{{ section.id }}-placeholder-media-list" class="product__media-nav">
          <button
            class="product__media-prev-next {% if section.settings.show_thumbnails_on_mobile %}hidden-pocket{% endif %} hidden-lap-and-up tap-area tap-area--large"
            aria-label="{{ 'general.accessibility.previous' | t }}"
            data-action="prev"
          >
            {%- render 'icon' with 'nav-arrow-left' -%}
          </button>

          {%- unless section.settings.show_thumbnails_on_mobile -%}
            <div class="dots-nav dots-nav--centered hidden-lap-and-up">
              {%- for i in (1..3) -%}
                <button
                  type="button"
                  tabindex="-1"
                  class="dots-nav__item tap-area"
                  {% if forloop.first %}
                    aria-current="true"
                  {% endif %}
                  aria-controls="product-{{ section.id }}-media-{{ forloop.index }}"
                  data-media-id="media-{{ forloop.index }}"
                  data-action="select"
                >
                      <span class="visually-hidden">
                        {{- 'general.accessibility.go_to_slide' | t: num: forloop.index -}}
                      </span>
                </button>
              {%- endfor -%}
            </div>
          {%- endunless -%}

          <scroll-shadow class="product__thumbnail-scroll-shadow {% unless section.settings.show_thumbnails_on_mobile %}hidden-pocket{% endunless %}">
            <div class="product__thumbnail-list hide-scrollbar">
              <div class="product__thumbnail-list-inner">
                {%- for i in (1..3) -%}
                  <button
                    type="button"
                    tabindex="-1"
                    class="product__thumbnail-item {% unless section.settings.show_thumbnails_on_mobile %}hidden-pocket{% endunless %}"
                    {% if forloop.first %}
                      aria-current="true"
                    {% endif %}
                    aria-controls="product-{{ section.id }}-media-{{ forloop.index }}"
                    data-media-id="media-{{ forloop.index }}"
                    data-action="select"
                  >
                    <div class="product__thumbnail">
                      {%- capture image_placeholder -%}product-{{ i }}{%- endcapture -%}
                      {{- image_placeholder | placeholder_svg_tag: 'placeholder-background' -}}
                    </div>
                  </button>
                {%- endfor -%}
              </div>
            </div>
          </scroll-shadow>

          <button
            class="product__media-prev-next {% if section.settings.show_thumbnails_on_mobile %}hidden-pocket{% endif %} hidden-lap-and-up tap-area tap-area--large"
            aria-label="{{ 'general.accessibility.next' | t }}"
            data-action="next"
          >
            {%- render 'icon' with 'nav-arrow-right' -%}
          </button>
        </flickity-controls>
      </product-media>

      <div class="product__info">
        <product-meta
          form-id="product-form-{{ section.id }}-{{ featured_product.id }}"
          price-class="price--large"
          class="product-meta"
        >
          {%- if section.settings.show_vendor -%}
            <h2 class="product-meta__vendor heading heading--small">
              {{ 'general.onboarding.product_vendor' | t }}
            </h2>
          {%- endif -%}

          <h2 class="product-meta__title heading h3">{{ 'general.onboarding.product_title' | t }}</h2>

          <div class="product-meta__price-list-container" role="region" aria-live="polite">
            <div class="price-list" data-product-price-list>
                  <span class="price price--large">
                    <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                    {% render 'f_format_money' with 4500 %}
                  </span>
            </div>
          </div>

          {%- if section.settings.show_taxes_included -%}
            {%- if cart.taxes_included or shop.shipping_policy.body != blank -%}
              <p class="product-meta__taxes-included text--small">
                {%- if cart.taxes_included -%}
                  {{ 'product.general.include_taxes' | t }}
                {%- endif -%}

                {%- if shop.shipping_policy.body != blank -%}
                  {{ 'product.general.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                {%- endif -%}
              </p>
            {%- endif -%}
          {%- endif -%}

          {%- if section.settings.show_product_rating or section.settings.show_sku -%}
            <div class="product-meta__reference">
              {%- if section.settings.show_product_rating -%}
                <a href="#" class="product-meta__reviews-badge">
                  <div class="rating">
                    <div
                      class="rating__stars"
                      role="img"
                      aria-label="{{ 'general.accessibility.star_reviews_info' | t: rating_value: 5, rating_max: 5 }}"
                    >
                      {%- for i in (1..5) -%}
                        {%- render 'icon' with 'rating-star', class: 'rating__star rating__star--full' -%}
                      {%- endfor -%}
                    </div>

                    <span class="rating__caption">{{ 'product.general.reviews_count' | t: count: 2 }}</span>
                  </div>
                </a>
              {%- endif -%}

              {%- if section.settings.show_sku -%}
                <span class="product-meta__sku text--subdued text--xxsmall">
                      {{- 'product.general.sku' | t }} 123-SKU</span
                >
              {%- endif -%}
            </div>
          {%- endif -%}
        </product-meta>

        <div class="product-form">
          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {%- when 'quantity_selector' -%}
                <div class="product-form__quantity" {{ block.shopify_attributes }}>
                  <span class="product-form__quantity-label">{{ 'product.form.quantity' | t }}:</span>

                  <quantity-selector class="quantity-selector">
                    <button type="button" class="quantity-selector__button">
                      <span class="visually-hidden">{{ 'cart.general.decrease_quantity' | t }}</span>
                      {%- render 'icon' with 'minus-big' -%}
                    </button>

                    <input
                      type="text"
                      is="input-number"
                      class="quantity-selector__input"
                      inputmode="numeric"
                      name="quantity"
                      autocomplete="off"
                      min="1"
                      value="1"
                      size="2"
                      aria-label="{{ 'product.form.quantity' | t | escape }}"
                    >

                    <button type="button" class="quantity-selector__button">
                      <span class="visually-hidden">{{ 'cart.general.increase_quantity' | t }}</span>
                      {%- render 'icon' with 'plus-big' -%}
                    </button>
                  </quantity-selector>
                </div>
              {%- when 'description' -%}
                <div class="product-form__description rte" {{ block.shopify_attributes }}>
                  {{- 'general.onboarding.product_description' | t -}}
                </div>
              {%- when 'inventory' -%}
                <product-inventory class="product-form__inventory-wrapper" {{ block.shopify_attributes }}>
                  <span class="inventory inventory--high">{{ 'product.form.in_stock' | t }}</span>
                </product-inventory>
              {%- when 'buy_buttons' -%}
                {%- if request.page_type != 'password' -%}
                  <product-payment-container
                    class="product-form__payment-container"
                    {% if settings.back_in_stock_enabled %}
                      {%- case settings.back_in_stock_app -%}
                        {%- when 'back_in_stock' -%}
                          back-in-stock-enabled
                      {%- endcase -%}
                    {% endif %}
                    {{ block.shopify_attributes }}
                  >
                    <button
                      type="submit"
                      data-product-add-to-cart-button
                      {% unless section.settings.show_payment_button %}
                        data-use-primary
                      {% endunless %}
                      class="product-form__add-button button button--primary button--full"
                    >
                      {{- 'product.form.add_to_cart' | t -}}
                    </button>
                  </product-payment-container>
                {%- endif -%}
            {%- endcase -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </div>
{% endcapture %}

{% render 'section-layout',
  content: content,
  extra_section_style: section_style,
  section_attributes: section_attributes
%}
