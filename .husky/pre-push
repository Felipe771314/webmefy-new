#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

set -e  # Detener el script en el primer error

echo "ðŸš€ Ejecutando pruebas antes del push..."

# Ejecuta las pruebas con cobertura usando Jest
npm test -- --coverage --maxWorkers=2

# Define el umbral mÃ­nimo de cobertura
COVERAGE_THRESHOLD=80

# Verifica que exista el archivo de resumen de cobertura
if [ -f "./coverage/coverage-summary.json" ]; then
  # Extrae la cobertura de statements
  ACTUAL_COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.statements.pct)")
  
  # Compara la cobertura actual con el umbral utilizando bc para cÃ¡lculos en flotante
  if (( $(echo "$ACTUAL_COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
    echo "âŒ La cobertura de cÃ³digo ($ACTUAL_COVERAGE%) es menor al $COVERAGE_THRESHOLD%. Corrige esto antes de hacer push."
    exit 1
  fi

  echo "âœ… Cobertura aceptable ($ACTUAL_COVERAGE%)."
else
  echo "âš ï¸  No se encontrÃ³ coverage/coverage-summary.json. Saltando verificaciÃ³n de cobertura."
fi

echo "ðŸ”„ Ejecutando sincronizaciÃ³n de archivos Liquid..."

# Ejecuta el script de sincronizaciÃ³n
if npm run sync:liquid; then
  echo "âœ… SincronizaciÃ³n de archivos Liquid completada."
else
  echo "âŒ Error durante la sincronizaciÃ³n de archivos Liquid."
  exit 1
fi
